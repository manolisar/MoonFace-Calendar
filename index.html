<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Moon Phases Calendar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
            background: radial-gradient(ellipse at top, #0a0a1e 0%, #000000 50%, #000000 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(138, 43, 226, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(75, 0, 130, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(72, 61, 139, 0.06) 0%, transparent 50%);
            animation: float 30s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(15, 15, 25, 0.85);
            backdrop-filter: blur(60px);
            border-radius: 32px;
            padding: 40px;
            border: 1px solid rgba(138, 43, 226, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 80px rgba(138, 43, 226, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            z-index: 1;
        }

        h1 {
            text-align: center;
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 32px;
            background: linear-gradient(135deg, #ffffff 0%, #b8a9ff 50%, #8a67ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            text-shadow: 0 0 40px rgba(138, 103, 255, 0.3);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        label {
            font-weight: 600;
            font-size: 17px;
            color: #ffffff;
            letter-spacing: -0.2px;
        }

        select, input {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            background: rgba(58, 58, 60, 0.8);
            color: #ffffff;
            font-size: 17px;
            font-weight: 500;
            text-align: center;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
            -webkit-appearance: none;
            font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        }

        select:focus, input:focus {
            outline: none;
            border: 2px solid #007AFF;
            background: rgba(58, 58, 60, 1);
        }

        select option {
            background: #1c1c1e;
            color: white;
        }

        input::placeholder {
            color: rgba(235, 235, 245, 0.6);
        }

        button {
            padding: 12px 32px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(135deg, #8a2be2 0%, #6a1bb2 100%);
            color: white;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            letter-spacing: -0.2px;
            box-shadow: 
                0 4px 16px rgba(138, 43, 226, 0.3),
                0 0 0 0 rgba(138, 43, 226, 0.5);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            background: linear-gradient(135deg, #9d3ef5 0%, #7b29c9 100%);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 24px rgba(138, 43, 226, 0.4),
                0 0 40px rgba(138, 43, 226, 0.3);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 
                0 2px 8px rgba(138, 43, 226, 0.4);
        }

        .intro {
            text-align: center;
            margin-bottom: 32px;
            color: rgba(235, 235, 245, 0.85);
        }

        .intro-tagline {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.2px;
            margin-bottom: 8px;
        }

        .intro-subtitle {
            font-size: 16px;
            color: rgba(235, 235, 245, 0.65);
            max-width: 640px;
            margin: 0 auto;
            line-height: 1.5;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 36px;
        }

        .insight-card {
            background: linear-gradient(145deg, rgba(30, 30, 45, 0.85), rgba(18, 18, 32, 0.95));
            border-radius: 18px;
            padding: 22px 24px;
            border: 1px solid rgba(138, 43, 226, 0.18);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            gap: 6px;
            position: relative;
            overflow: hidden;
        }

        .insight-card::after {
            content: '';
            position: absolute;
            top: -40%;
            right: -40%;
            width: 70%;
            height: 140%;
            background: radial-gradient(circle, rgba(138, 43, 226, 0.22) 0%, transparent 65%);
            opacity: 0.6;
        }

        .insight-label {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(235, 235, 245, 0.58);
        }

        .insight-value {
            font-size: 22px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: -0.4px;
        }

        .insight-meta {
            font-size: 13px;
            color: rgba(235, 235, 245, 0.6);
            line-height: 1.5;
        }

        .highlights {
            margin-bottom: 36px;
        }

        .highlights-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
            color: rgba(235, 235, 245, 0.85);
            letter-spacing: -0.2px;
            margin-bottom: 14px;
        }

        .highlights-title span {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .highlights-title svg {
            width: 18px;
            height: 18px;
            fill: rgba(138, 43, 226, 0.8);
        }

        .highlight-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .highlight-pill {
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(138, 43, 226, 0.25);
            border-radius: 999px;
            padding: 10px 16px;
            font-size: 13px;
            color: rgba(235, 235, 245, 0.9);
            display: inline-flex;
            flex-direction: column;
            gap: 3px;
            min-width: 170px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
        }

        .highlight-pill small {
            font-size: 11px;
            color: rgba(235, 235, 245, 0.55);
            letter-spacing: 0.2px;
        }

        .highlight-pill--full {
            border-color: rgba(255, 214, 102, 0.55);
            background: rgba(255, 214, 102, 0.14);
        }

        .highlight-pill--new {
            border-color: rgba(137, 148, 255, 0.45);
            background: rgba(120, 132, 255, 0.12);
        }

        .highlight-pill--first-quarter,
        .highlight-pill--last-quarter {
            border-color: rgba(143, 231, 201, 0.45);
            background: rgba(143, 231, 201, 0.12);
        }

        .highlight-pill.muted {
            border-style: dashed;
            border-color: rgba(235, 235, 245, 0.18);
            color: rgba(235, 235, 245, 0.6);
        }

        .phase-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 20px;
            padding: 18px 0 6px;
            color: rgba(235, 235, 245, 0.6);
            font-size: 13px;
            letter-spacing: 0.2px;
        }

        .phase-legend-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .phase-dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: rgba(235, 235, 245, 0.4);
            box-shadow: 0 0 8px rgba(138, 43, 226, 0.3);
        }

        .phase-dot--full { background: #ffd666; }
        .phase-dot--new { background: #5b5f7a; }
        .phase-dot--waxing { background: #8a2be2; }
        .phase-dot--waning { background: #5b9fff; }

        .calendar-header {
            text-align: center;
            margin-bottom: 24px;
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: -0.5px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1px;
            margin-top: 20px;
            overflow: hidden;
        }

        .day-header {
            background: rgba(28, 28, 30, 1);
            padding: 16px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            color: rgba(235, 235, 245, 0.6);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .calendar-day {
            background: rgba(20, 20, 35, 0.6);
            padding: 12px 8px;
            text-align: center;
            min-height: 110px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 8px;
        }

        .calendar-day:hover {
            background: rgba(138, 43, 226, 0.15);
            transform: translateY(-2px);
            box-shadow: 
                0 4px 16px rgba(138, 43, 226, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.25), rgba(106, 27, 178, 0.25));
            border: 2px solid #8a2be2;
            box-shadow: 
                0 0 20px rgba(138, 43, 226, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .calendar-day.today:hover {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.35), rgba(106, 27, 178, 0.35));
            box-shadow: 
                0 0 30px rgba(138, 43, 226, 0.5),
                0 4px 16px rgba(138, 43, 226, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .day-number {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
            letter-spacing: -0.3px;
        }

        .calendar-day.other-month .day-number {
            color: rgba(235, 235, 245, 0.3);
        }

        .moon-mini {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            position: relative;
            margin-bottom: 8px;
            background: radial-gradient(circle at 45% 32%, #fefced 0%, #ede5ff 56%, #cbbffd 74%, #17152d 100%);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.45),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 0 0 0.5px rgba(255, 255, 255, 0.12);
            overflow: hidden;
            transition: transform 0.35s ease, box-shadow 0.35s ease;
        }

        .moon-mini::before,
        .moon-mini::after {
            content: '';
            position: absolute;
            inset: -3%;
            border-radius: 50%;
            transition: transform 0.45s ease, opacity 0.45s ease;
        }

        .moon-mini::before {
            background: radial-gradient(circle at 50% 50%, rgba(8, 10, 36, 0.95) 56%, rgba(8, 10, 36, 0.15) 78%, rgba(8, 10, 36, 0) 92%);
            transform: translateX(var(--shadow-shift, 0%)) scaleX(var(--shadow-scale, 1.1));
            opacity: var(--shadow-opacity, 0.4);
            mix-blend-mode: multiply;
        }

        .moon-mini::after {
            background: radial-gradient(circle at 65% 32%, rgba(255, 255, 255, var(--glow, 0.45)) 0%, rgba(255, 255, 255, 0.05) 48%, rgba(255, 255, 255, 0) 72%);
            transform: translateX(var(--highlight-shift, 0%));
            opacity: 0.9;
            mix-blend-mode: screen;
        }

        .moon-mini[data-orbit="waning"]::after {
            background: radial-gradient(circle at 35% 32%, rgba(255, 255, 255, var(--glow, 0.45)) 0%, rgba(255, 255, 255, 0.05) 48%, rgba(255, 255, 255, 0) 72%);
        }

        .moon-mini[data-phase="full"]::before {
            opacity: 0;
        }

        .moon-mini[data-phase="new"] {
            background: radial-gradient(circle at 50% 50%, #141328 0%, #070613 100%);
        }

        .moon-mini[data-phase="new"]::after {
            opacity: 0.25;
        }

        .calendar-day:hover .moon-mini {
            transform: scale(1.08);
            box-shadow: 
                0 6px 14px rgba(138, 43, 226, 0.28),
                0 0 24px rgba(138, 43, 226, 0.22);
        }

        .phase-info {
            font-size: 11px;
            text-align: center;
            line-height: 1.2;
            font-weight: 500;
        }

        .phase-name {
            color: rgba(235, 235, 245, 0.8);
            margin-bottom: 2px;
            letter-spacing: -0.1px;
        }

        .illumination {
            color: rgba(235, 235, 245, 0.6);
            font-size: 10px;
            font-weight: 400;
        }

        .loading {
            text-align: center;
            font-size: 17px;
            padding: 40px;
            color: rgba(235, 235, 245, 0.8);
        }

        .error {
            background: rgba(255, 69, 58, 0.1);
            border: 1px solid rgba(255, 69, 58, 0.3);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
            color: #FF453A;
            font-weight: 500;
        }

        /* Dark mode enhancements */
        @media (prefers-color-scheme: dark) {
            body {
                background: #000000;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
            }
            
            .container {
                padding: 24px;
                border-radius: 16px;
            }
            
            h1 {
                font-size: 28px;
                margin-bottom: 24px;
            }

            .intro {
                margin-bottom: 24px;
            }

            .intro-tagline {
                font-size: 18px;
            }

            .intro-subtitle {
                font-size: 15px;
            }

            .insights-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 12px;
                margin-bottom: 28px;
            }

            .insight-card {
                padding: 18px 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
                gap: 16px;
                margin-bottom: 32px;
            }
            
            .input-group {
                width: 100%;
                max-width: 200px;
            }
            
            select, input {
                width: 100%;
                padding: 14px 20px;
                font-size: 17px;
            }
            
            button {
                width: 100%;
                max-width: 240px;
                padding: 14px 24px;
                font-size: 17px;
            }
            
            .calendar-grid {
                gap: 0.5px;
                padding: 0.5px;
            }
            
            .calendar-day {
                min-height: 90px;
                padding: 8px 4px;
            }
            
            .moon-mini {
                width: 28px;
                height: 28px;
            }
            
            .phase-info {
                font-size: 10px;
            }
            
            .day-number {
                font-size: 18px;
                margin-bottom: 6px;
            }
            
            .day-header {
                padding: 12px 4px;
                font-size: 12px;
            }

            .calendar-header {
                font-size: 24px;
                margin-bottom: 20px;
            }

            .highlight-pills {
                gap: 8px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 12px;
            }
            
            .container {
                padding: 20px;
                border-radius: 12px;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .controls {
                gap: 12px;
                margin-bottom: 24px;
            }

            .insights-grid {
                grid-template-columns: 1fr;
            }

            select, input, button {
                font-size: 16px;
                padding: 12px 16px;
            }
            
            .calendar-day {
                min-height: 75px;
                padding: 6px 3px;
            }
            
            .moon-mini {
                width: 24px;
                height: 24px;
            }
            
            .phase-info {
                font-size: 9px;
            }
            
            .day-number {
                font-size: 16px;
                margin-bottom: 5px;
            }
            
            .day-header {
                padding: 10px 2px;
                font-size: 11px;
            }
            
            .calendar-header {
                font-size: 22px;
                margin-bottom: 16px;
            }
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Selection styling */
        ::selection {
            background: rgba(0, 122, 255, 0.3);
        }

        /* Focus visible for accessibility */
        button:focus-visible,
        select:focus-visible,
        input:focus-visible {
            outline: 2px solid #007AFF;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌙 Moon Calendar</h1>

        <div class="intro">
            <p class="intro-tagline">Follow the lunar story for any month.</p>
            <p class="intro-subtitle">Pick a timeframe to explore each night’s moon phase, see the next major events, and plan the perfect stargazing session.</p>
        </div>

        <div class="insights-grid">
            <div class="insight-card">
                <span class="insight-label">Now</span>
                <span class="insight-value" id="current-phase-name">Loading…</span>
                <span class="insight-meta" id="current-phase-detail">Preparing moon data…</span>
            </div>
            <div class="insight-card">
                <span class="insight-label">Next Full Moon</span>
                <span class="insight-value" id="next-full-date">Loading…</span>
                <span class="insight-meta" id="next-full-context">—</span>
            </div>
            <div class="insight-card">
                <span class="insight-label">Next New Moon</span>
                <span class="insight-value" id="next-new-date">Loading…</span>
                <span class="insight-meta" id="next-new-context">—</span>
            </div>
        </div>
        
        <div class="controls">
            <div class="input-group">
                <label for="month">Month</label>
                <select id="month">
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="year">Year</label>
                <input type="number" id="year" min="1900" max="2100" placeholder="2025">
            </div>
            
            <button onclick="generateCalendar()">Update</button>
        </div>

        <div class="highlights">
            <div class="highlights-title">
                <span>
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3.75a.75.75 0 0 1 .677.418l1.44 2.832 3.126.456a.75.75 0 0 1 .416 1.28l-2.26 2.203.534 3.11a.75.75 0 0 1-1.088.791L12 13.65l-2.845 1.49a.75.75 0 0 1-1.088-.79l.534-3.111-2.26-2.204a.75.75 0 0 1 .416-1.28l3.126-.456 1.44-2.832A.75.75 0 0 1 12 3.75Z"/></svg>
                    Upcoming highlights
                </span>
            </div>
            <div class="highlight-pills" id="highlight-dates">
                <span class="highlight-pill muted">Loading…</span>
            </div>
        </div>

        <div class="phase-legend">
            <div class="phase-legend-item"><span class="phase-dot phase-dot--new"></span>New moon</div>
            <div class="phase-legend-item"><span class="phase-dot phase-dot--waxing"></span>Waxing phases</div>
            <div class="phase-legend-item"><span class="phase-dot phase-dot--full"></span>Full moon</div>
            <div class="phase-legend-item"><span class="phase-dot phase-dot--waning"></span>Waning phases</div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Initialize with current date
        const now = new Date();
        const MONTH_NAMES = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        const DAY_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const DAY_MS = 1000 * 60 * 60 * 24;
        const RAD = Math.PI / 180;
        const J1970 = 2440588;
        const J2000 = 2451545;
        const OBLIQUITY = RAD * 23.4397;
        const SUN_DISTANCE = 149598000; // km
        const PRIMARY_PHASES = [
            { key: 'new', name: 'New Moon', target: 0 },
            { key: 'first-quarter', name: 'First Quarter', target: 0.25 },
            { key: 'full', name: 'Full Moon', target: 0.5 },
            { key: 'last-quarter', name: 'Last Quarter', target: 0.75 }
        ];
        const PHASE_NAMES = {
            'new': 'New Moon',
            'waxing-crescent': 'Waxing Crescent',
            'first-quarter': 'First Quarter',
            'waxing-gibbous': 'Waxing Gibbous',
            'full': 'Full Moon',
            'waning-gibbous': 'Waning Gibbous',
            'last-quarter': 'Last Quarter',
            'waning-crescent': 'Waning Crescent'
        };
        const PHASE_TARGETS = PRIMARY_PHASES.reduce((acc, phase) => {
            acc[phase.key] = phase.target;
            return acc;
        }, {});
        const MAJOR_PHASE_THRESHOLD = 0.012;
        const MAJOR_PHASE_LEEWAY = 0.004;
        const PHASE_MATCH_TOLERANCE = 0.015;
        document.getElementById('month').value = now.getMonth() + 1;
        document.getElementById('year').value = now.getFullYear();

        function toJulian(date) {
            return date.valueOf() / DAY_MS - 0.5 + J1970;
        }

        function toDays(date) {
            return toJulian(date) - J2000;
        }

        function rightAscension(l, b) {
            return Math.atan2(Math.sin(l) * Math.cos(OBLIQUITY) - Math.tan(b) * Math.sin(OBLIQUITY), Math.cos(l));
        }

        function declination(l, b) {
            return Math.asin(Math.sin(b) * Math.cos(OBLIQUITY) + Math.cos(b) * Math.sin(OBLIQUITY) * Math.sin(l));
        }

        function solarMeanAnomaly(d) {
            return RAD * (357.5291 + 0.98560028 * d);
        }

        function eclipticLongitude(M) {
            const C = RAD * (1.9148 * Math.sin(M) + 0.02 * Math.sin(2 * M) + 0.0003 * Math.sin(3 * M));
            const P = RAD * 102.9372;
            return M + C + P + Math.PI;
        }

        function sunCoords(d) {
            const M = solarMeanAnomaly(d);
            const L = eclipticLongitude(M);
            return {
                dec: declination(L, 0),
                ra: rightAscension(L, 0)
            };
        }

        function moonCoords(d) {
            const L = RAD * (218.316 + 13.176396 * d);
            const M = RAD * (134.963 + 13.064993 * d);
            const F = RAD * (93.272 + 13.229350 * d);

            const l = L + RAD * 6.289 * Math.sin(M);
            const b = RAD * 5.128 * Math.sin(F);
            const dt = 385001 - 20905 * Math.cos(M);

            return {
                ra: rightAscension(l, b),
                dec: declination(l, b),
                dist: dt
            };
        }

        function getMoonIllumination(date) {
            const d = toDays(date);
            const s = sunCoords(d);
            const m = moonCoords(d);

            const phi = Math.acos(
                Math.sin(s.dec) * Math.sin(m.dec) +
                Math.cos(s.dec) * Math.cos(m.dec) * Math.cos(s.ra - m.ra)
            );

            const inc = Math.atan2(SUN_DISTANCE * Math.sin(phi), m.dist - SUN_DISTANCE * Math.cos(phi));
            const angle = Math.atan2(
                Math.cos(s.dec) * Math.sin(s.ra - m.ra),
                Math.sin(s.dec) * Math.cos(m.dec) - Math.cos(s.dec) * Math.sin(m.dec) * Math.cos(s.ra - m.ra)
            );

            const phase = 0.5 + 0.5 * inc * (angle < 0 ? -1 : 1) / Math.PI;
            const normalizedPhase = (phase + 1) % 1;

            return {
                fraction: (1 + Math.cos(inc)) / 2,
                phase: normalizedPhase,
                angle
            };
        }

        function phaseDistance(age, target) {
            const diff = Math.abs(age - target);
            return Math.min(diff, 1 - diff);
        }

        function signedPhaseDelta(age, target) {
            return (((age - target) + 0.5) % 1) - 0.5;
        }

        function getPhaseFromAge(age) {
            const normalized = ((age % 1) + 1) % 1;
            let bestPrimary = null;

            for (const phase of PRIMARY_PHASES) {
                const diff = phaseDistance(normalized, phase.target);
                if (diff <= MAJOR_PHASE_THRESHOLD) {
                    const signed = signedPhaseDelta(normalized, phase.target);
                    if (signed <= MAJOR_PHASE_LEEWAY) {
                        if (!bestPrimary || diff < bestPrimary.diff) {
                            bestPrimary = { key: phase.key, name: phase.name, diff, signed, target: phase.target };
                        }
                    }
                }
            }

            if (bestPrimary) {
                return {
                    key: bestPrimary.key,
                    name: bestPrimary.name,
                    primary: {
                        key: bestPrimary.key,
                        name: bestPrimary.name,
                        diff: bestPrimary.diff,
                        signed: bestPrimary.signed,
                        target: bestPrimary.target
                    }
                };
            }

            if (normalized < 0.25) {
                return { key: 'waxing-crescent', name: PHASE_NAMES['waxing-crescent'] };
            }
            if (normalized < 0.5) {
                return { key: 'waxing-gibbous', name: PHASE_NAMES['waxing-gibbous'] };
            }
            if (normalized < 0.75) {
                return { key: 'waning-gibbous', name: PHASE_NAMES['waning-gibbous'] };
            }
            return { key: 'waning-crescent', name: PHASE_NAMES['waning-crescent'] };
        }

        function getMoonPhaseForDate(date) {
            const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            let bestSample = null;

            for (let hour = 0; hour < 24; hour++) {
                // sample at the middle of each hour to capture peaks near boundaries
                const sample = new Date(dayStart.getTime() + hour * 60 * 60 * 1000 + 30 * 60 * 1000);
                const metrics = getMoonIllumination(sample);
                const fractionPercent = metrics.fraction * 100;

                if (!bestSample || fractionPercent > bestSample.illumination) {
                    bestSample = {
                        illumination: fractionPercent,
                        age: metrics.phase,
                        sampleDate: sample
                    };
                }
            }

            const phase = getPhaseFromAge(bestSample.age);
            const illuminationPercent = Math.max(0, Math.min(100, Math.round(bestSample.illumination)));
            return {
                phase: phase.key,
                name: phase.name,
                illumination: illuminationPercent,
                age: bestSample.age,
                sampleDate: bestSample.sampleDate,
                primaryPhase: phase.primary || null
            };
        }

        function generateCalendar() {
            const month = parseInt(document.getElementById('month').value);
            const year = parseInt(document.getElementById('year').value);
            
            if (!year || year < 1900 || year > 2100) {
                showError('Please enter a valid year between 1900 and 2100');
                return;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Updating calendar...</div>';

            try {
                displayCalendar(year, month);
            } catch (error) {
                showError('Error generating calendar: ' + error.message);
            }
        }

        function setInsightsPlaceholder(message) {
            const currentName = document.getElementById('current-phase-name');
            const currentDetail = document.getElementById('current-phase-detail');
            const nextFullDate = document.getElementById('next-full-date');
            const nextFullContext = document.getElementById('next-full-context');
            const nextNewDate = document.getElementById('next-new-date');
            const nextNewContext = document.getElementById('next-new-context');
            const highlightContainer = document.getElementById('highlight-dates');

            if (currentName) currentName.textContent = '—';
            if (currentDetail) currentDetail.textContent = message;
            if (nextFullDate) nextFullDate.textContent = '—';
            if (nextFullContext) nextFullContext.textContent = message;
            if (nextNewDate) nextNewDate.textContent = '—';
            if (nextNewContext) nextNewContext.textContent = message;
            if (highlightContainer) {
                highlightContainer.innerHTML = '<span class="highlight-pill muted">' + message + '</span>';
            }
        }

        function updateInsights(year, month) {
            const monthStart = new Date(year, month - 1, 1);
            const monthEnd = new Date(year, month, 0);
            const daysInMonth = monthEnd.getDate();
            const isCurrentMonth = now.getFullYear() === year && (now.getMonth() + 1) === month;
            const referenceDay = Math.min(15, daysInMonth);
            const referenceDate = isCurrentMonth ? new Date(now) : new Date(year, month - 1, referenceDay);
            const phaseInfo = getMoonPhaseForDate(referenceDate);

            const currentName = document.getElementById('current-phase-name');
            const currentDetail = document.getElementById('current-phase-detail');
            if (currentName) currentName.textContent = phaseInfo.name;
            if (currentDetail) {
                const descriptor = isCurrentMonth ? 'Today' : MONTH_NAMES[month - 1];
                const sampleDate = phaseInfo.sampleDate || referenceDate;
                currentDetail.textContent = `${descriptor} · ${formatDateWithTime(sampleDate)} · ${phaseInfo.illumination}% illuminated`;
            }

            const nextFull = findNextPhase(monthStart, 'full', monthEnd);
            const nextFullDate = document.getElementById('next-full-date');
            const nextFullContext = document.getElementById('next-full-context');
            if (nextFull && nextFullDate && nextFullContext) {
                const peakDate = nextFull.phaseInfo?.sampleDate || nextFull.date;
                nextFullDate.textContent = formatDate(nextFull.date);
                nextFullContext.textContent = nextFull.withinRange
                    ? `Peaks ${formatDateTime(peakDate)} (${formatUTCTime(peakDate)})`
                    : `Next on ${formatMonthYear(nextFull.date)}`;
            } else {
                if (nextFullDate) nextFullDate.textContent = '—';
                if (nextFullContext) nextFullContext.textContent = 'No data available';
            }

            const nextNew = findNextPhase(monthStart, 'new', monthEnd);
            const nextNewDate = document.getElementById('next-new-date');
            const nextNewContext = document.getElementById('next-new-context');
            if (nextNew && nextNewDate && nextNewContext) {
                const peakDate = nextNew.phaseInfo?.sampleDate || nextNew.date;
                nextNewDate.textContent = formatDate(nextNew.date);
                nextNewContext.textContent = nextNew.withinRange
                    ? `Goes dark ${formatDateTime(peakDate)} (${formatUTCTime(peakDate)})`
                    : `Next on ${formatMonthYear(nextNew.date)}`;
            } else {
                if (nextNewDate) nextNewDate.textContent = '—';
                if (nextNewContext) nextNewContext.textContent = 'No data available';
            }

            const highlights = getPhaseHighlights(year, month);
            const highlightContainer = document.getElementById('highlight-dates');
            if (highlightContainer) {
                if (highlights.length) {
                    highlightContainer.innerHTML = highlights.map(({ phase, name, date, sampleDate }) => {
                        const when = sampleDate || date;
                        return `<span class="highlight-pill ${getHighlightClass(phase)}">${name}<small>${formatDateWithTime(when)}</small></span>`;
                    }).join('');
                } else {
                    highlightContainer.innerHTML = '<span class="highlight-pill muted">No major phase milestones in this month.</span>';
                }
            }
        }

        function findNextPhase(startDate, targetPhase, limitDate = null) {
            const cursor = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const targetAge = PHASE_TARGETS[targetPhase];
            const limitMs = limitDate ? new Date(limitDate.getFullYear(), limitDate.getMonth(), limitDate.getDate()).getTime() : null;
            const maxDays = limitDate ? Math.ceil((limitMs - cursor.getTime()) / (1000 * 60 * 60 * 24)) + 60 : 160;
            const tolerance = PHASE_MATCH_TOLERANCE;

            for (let i = 0; i < maxDays; i++) {
                const phaseInfo = getMoonPhaseForDate(cursor);
                const primary = phaseInfo.primaryPhase;
                if (primary && primary.key === targetPhase) {
                    const withinRange = limitMs ? cursor.getTime() <= limitMs : true;
                    return { date: new Date(cursor), withinRange, phaseInfo };
                }

                const diff = phaseDistance(phaseInfo.age, targetAge);
                const signed = signedPhaseDelta(phaseInfo.age, targetAge);
                if (diff <= tolerance && signed <= MAJOR_PHASE_LEEWAY) {
                    const withinRange = limitMs ? cursor.getTime() <= limitMs : true;
                    return { date: new Date(cursor), withinRange, phaseInfo };
                }
                cursor.setDate(cursor.getDate() + 1);
            }
            return null;
        }

        function getPhaseHighlights(year, month) {
            const daysInMonth = new Date(year, month, 0).getDate();
            const dailyData = [];

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const phaseInfo = getMoonPhaseForDate(date);
                dailyData.push({ ...phaseInfo, date });
            }

            const targets = [
                { phase: 'new', name: 'New Moon' },
                { phase: 'first-quarter', name: 'First Quarter' },
                { phase: 'full', name: 'Full Moon' },
                { phase: 'last-quarter', name: 'Last Quarter' }
            ];

            const results = [];

            targets.forEach(target => {
                const targetAge = PHASE_TARGETS[target.phase];
                let best = null;

                dailyData.forEach(entry => {
                    const primary = entry.primaryPhase;
                    let diff;
                    let priority = 2;

                    if (primary && primary.key === target.phase) {
                        diff = primary.diff;
                        priority = 0;
                    } else {
                        diff = phaseDistance(entry.age, targetAge);
                        const signed = signedPhaseDelta(entry.age, targetAge);
                        if (signed <= MAJOR_PHASE_LEEWAY) {
                            priority = 1;
                        }
                    }

                    if (!best || priority < best.priority || (priority === best.priority && diff < best.diff) || (priority === best.priority && Math.abs(diff - best.diff) < 1e-6 && entry.illumination > best.illumination)) {
                        best = { ...entry, diff, priority };
                    }
                });

                if (best) {
                    results.push({ phase: target.phase, name: target.name, date: best.date, sampleDate: best.sampleDate });
                }
            });

            results.sort((a, b) => a.date - b.date);
            return results;
        }

        function formatDate(date) {
            return date.toLocaleDateString(undefined, {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateTime(date) {
            return date.toLocaleString(undefined, {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatUTCTime(date) {
            return date.toLocaleTimeString(undefined, {
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'UTC',
                hour12: false
            }) + ' UTC';
        }

        function formatDateWithTime(date) {
            const local = formatDateTime(date);
            const utc = formatUTCTime(date);
            return `${local} · ${utc}`;
        }

        function formatMonthYear(date) {
            return date.toLocaleDateString(undefined, {
                month: 'long',
                year: 'numeric'
            });
        }

        function getHighlightClass(phase) {
            switch (phase) {
                case 'full':
                    return 'highlight-pill--full';
                case 'new':
                    return 'highlight-pill--new';
                case 'first-quarter':
                case 'last-quarter':
                    return 'highlight-pill--first-quarter';
                default:
                    return '';
            }
        }

        function displayCalendar(year, month) {
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month - 1;
            const todayDate = today.getDate();

            let html = `
                <div class="calendar-header">
                    ${MONTH_NAMES[month - 1]} ${year}
                </div>
                <div class="calendar-grid">
            `;

            // Add day headers
            DAY_NAMES.forEach(day => {
                html += `<div class="day-header">${day}</div>`;
            });

            // Add empty cells for days before month starts
            for (let i = 0; i < startingDay; i++) {
                const prevMonth = month === 1 ? 12 : month - 1;
                const prevYear = month === 1 ? year - 1 : year;
                const prevMonthDays = new Date(prevYear, prevMonth, 0).getDate();
                const dayNum = prevMonthDays - (startingDay - 1 - i);
                const date = new Date(prevYear, prevMonth - 1, dayNum);
                const phaseInfo = getMoonPhaseForDate(date);
                
                html += `
                    <div class="calendar-day other-month">
                        <div class="day-number">${dayNum}</div>
                        ${getMoonMiniVisual(phaseInfo)}
                        <div class="phase-info">
                            <div class="phase-name">${getShortPhaseName(phaseInfo.name)}</div>
                            <div class="illumination">${phaseInfo.illumination}%</div>
                        </div>
                    </div>
                `;
            }

            // Add days of current month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const phaseInfo = getMoonPhaseForDate(date);
                const isToday = isCurrentMonth && day === todayDate;
                
                html += `
                    <div class="calendar-day${isToday ? ' today' : ''}">
                        <div class="day-number">${day}</div>
                        ${getMoonMiniVisual(phaseInfo)}
                        <div class="phase-info">
                            <div class="phase-name">${getShortPhaseName(phaseInfo.name)}</div>
                            <div class="illumination">${phaseInfo.illumination}%</div>
                        </div>
                    </div>
                `;
            }

            // Fill remaining cells for next month
            const totalCells = Math.ceil((daysInMonth + startingDay) / 7) * 7;
            const remainingCells = totalCells - (daysInMonth + startingDay);
            
            for (let day = 1; day <= remainingCells; day++) {
                const nextMonth = month === 12 ? 1 : month + 1;
                const nextYear = month === 12 ? year + 1 : year;
                const date = new Date(nextYear, nextMonth - 1, day);
                const phaseInfo = getMoonPhaseForDate(date);
                
                html += `
                    <div class="calendar-day other-month">
                        <div class="day-number">${day}</div>
                        ${getMoonMiniVisual(phaseInfo)}
                        <div class="phase-info">
                            <div class="phase-name">${getShortPhaseName(phaseInfo.name)}</div>
                            <div class="illumination">${phaseInfo.illumination}%</div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
            updateInsights(year, month);
        }

        function getMoonMiniVisual(phaseInfo) {
            const illuminationRatio = Math.max(0, Math.min(1, phaseInfo.illumination / 100));
            const normalizedAge = ((phaseInfo.age % 1) + 1) % 1;
            const shadowShift = (normalizedAge - 0.5) * 80;
            const shadowScale = 1 + (1 - illuminationRatio) * 0.65;
            const shadowOpacity = Math.min(0.92, 0.2 + (1 - illuminationRatio) * 0.85);
            const highlightShift = (0.5 - normalizedAge) * 50;
            const glow = 0.3 + illuminationRatio * 0.4;
            const orientation = normalizedAge <= 0.5 ? 'waxing' : 'waning';

            const style = [
                `--shadow-shift:${shadowShift}%`,
                `--shadow-scale:${shadowScale}`,
                `--shadow-opacity:${shadowOpacity}`,
                `--highlight-shift:${highlightShift}%`,
                `--glow:${glow}`
            ].join('; ');

            return `<div class="moon-mini" data-phase="${phaseInfo.phase}" data-orbit="${orientation}" style="${style}"></div>`;
        }

        function getShortPhaseName(fullName) {
            const shortNames = {
                'New Moon': 'New',
                'Waxing Crescent': 'Wax Cres',
                'First Quarter': '1st Qtr',
                'Waxing Gibbous': 'Wax Gib',
                'Full Moon': 'Full',
                'Waning Gibbous': 'Wan Gib',
                'Last Quarter': 'Last Qtr',
                'Waning Crescent': 'Wan Cres'
            };
            return shortNames[fullName] || fullName;
        }

        function showError(message) {
            document.getElementById('results').innerHTML = `<div class="error">${message}</div>`;
            setInsightsPlaceholder(message);
        }

        // Generate calendar for current month on load
        generateCalendar();
    </script>
</body>
</html>
